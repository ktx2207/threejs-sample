<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>three.jsサンプル</title>
    <script src="./lib/three.min.js"></script>
    <script src="./lib/TrackballControls.js"></script>
    <script src="./lib/DragControls.js"></script>
    <script src="./lib/Projector.js"></script>
    <style>
        *{padding:0px; margin:0px}
        div#canvas-frame{
            width: 500px;
            height: 500px;
        }
    </style>
    <script>
        window.addEventListener("load", function() {
           threeStart();
        });
        function threeStart() {
            initThree();
            initCamera();
            initLight();
            initObject();
            draw();
        }

        var renderer,scene,canvasFrame;

        function initThree() {
            canvasFrame = document.getElementById('canvas-frame');
            renderer = new  THREE.WebGLRenderer();
            if (!renderer) alert("three.jsの初期化に失敗しました。");
            // レンダラーオブジェクトのサイズ指定
            renderer.setSize(canvasFrame.clientWidth, canvasFrame.clientHeight);

            canvasFrame.appendChild(renderer.domElement);
            // レンダラーオブジェクトのクリアーカラー設定
            renderer.setClearColor(0xEEEEEE, 1.0);
            // シーンオブジェクトの生成
            scene = new THREE.Scene();
        }

        var camera;
        var trackball;
        var dragcontrols;
        var floor = 1;
        function initCamera() {
            camera = new THREE.PerspectiveCamera(45, canvasFrame.clientWidth / canvasFrame.clientHeight, 1, 10000);

            // カメラ位置設定
            camera.position.set(100,100,50);
            // カメラの上ベクトルの設定
            camera.up.set(0,0,1);
            // カメラの中心位置ベクトルの設定
            camera.lookAt({x: 0, y: 0, z: 0});

            // トラックボールオブジェクト生成
            trackball = new THREE.TrackballControls(camera, canvasFrame);
            // トラックボールによる回転を有効にする。
            trackball.noRotate = false;
            // 回転速度の設定
            trackball.rotateSpeed = 2.0;
            // トラックボールによるズームの有効化
            trackball.noZoom = false;
            // ズーム速度の設定
            trackball.zoomSpeed = 1.0;
            // トラックボールによるカメラ視野中心座標移動の有効化
            trackball.noPan = false;
            trackball.panSpeed = 1.0;
            trackball.target = new THREE.Vector3(0,0,10);
            // マウス左ボタンドラッグ終了で回転をストップさせる。
            trackball.staticMoving = true;
            // マウス左ボタンドラッグ終了後の回転の減衰定数設定
            trackball.dynamicDampingFactor = 0.3;
            var dragObject = null; // ドラッグ対象オブジェクト
            // ドラッグコントロールオブジェクトの生成
            dragcontrols = new THREE.DragControls(camera, null, renderer.domElement);
            // ドラッグコントロールを有効化
            dragcontrols.enabled = true;

            // マウスオーバーイベントの登録
            dragcontrols.on('hoveron', function(e){
                // トラックボールオブジェクトを無効化
                trackball.enabled = false;
                // マウスドラッグ対象オブジェクトを更新
                dragObject = e.object;
            });

            // マウスアウトイベントの登録
            dragcontrols.on('hoveroff', function(e){
                // トラックボールオブジェクトを有効化
                trackball.enabled = true;
//                // マウスオーバーしたオブジェクトが平面にない場合、位置を調整する。
                if(e) {
                    e.object.position.setZ(floor*5);
                    if(e.object.position.x > cubeX/2) {
                        e.object.position.setX(cubeX/2);
                    } else if(e.object.position.x < -1*cubeX/2) {
                        e.object.position.setX(-1*cubeX/2);
                    }

                    if(e.object.position.y > cubeY/2) {
                        e.object.position.setY(cubeY/2);
                    } else if(e.object.position.y < -1*cubeY/2) {
                        e.object.position.setY(-1*cubeY/2);
                    }

                }
                // ドラッグ対象オブジェクトを無しとする。
                dragObject = null;
            });
        }


        // 光源の初期化
        var directionalLight; // 平行光源オブジェクト
        function initLight() {
            directionalLight = new THREE.DirectionalLight(0xFFFFFF, 1.0);
            // 光源位置の設定
            directionalLight.position.set(50,50,100);
            // シーンへ光源を追加
            scene.add(directionalLight);
        }

        var axis; // 軸オブジェクト
        var cubeX = 50;
        var cubeY = 50;
        function initObject() {
            // グループを生成
            var objectGroup = new THREE.Group();

            // 軸オブジェクトの生成
            axis = new THREE.AxisHelper(50);
            // グループに軸オブジェクトを追加
            objectGroup.add(axis);
            // 軸オブジェクトの位置座標を設定
            axis.position.set(0, 0, 0);
            // グリッドオブジェクトの生成
            var grid = new THREE.GridHelper(50, 10);
            grid.rotation.set(Math.PI/2, 0, 0);
            objectGroup.add(grid);


            // 直方体を生成
            var height = 10;
            var cube1 =  createCube(cubeX, cubeY, height, false);
            var cube2 =  createCube(cubeX, cubeY, 50 - height, true);
            cube2.position.setZ(height+10);
            // 直方体をグループに追加
            objectGroup.add(cube1);
            objectGroup.add(cube2);

            // 回転体を追加
            objectGroup.add(createLathe(0,0,floor*5));
            objectGroup.add(createLathe(20,0,floor*5));


            // 回転体オブジェクトの配列をドラッグコントロール対象に追加
            dragcontrols.setObjects(lathes);

            // オブジェクトグループをシーンに追加
            scene.add(objectGroup);
        }

        function createCube(x, y, z, transparent) {
            // 形状オブジェクトを生成
            var geometry = new THREE.BoxGeometry(x, y, z);
            // 材質オブジェクトを生成
            var material = new THREE.MeshPhongMaterial({color: 0x008B8B, specular: 0x5F9EA0, shininess: 50, opacity: 0.2, transparent:transparent});
            // 直方体を生成
            return new THREE.Mesh(geometry, material);
        }

        var lathes=[]; // 回転体オブジェクトの配列
        // 回転体オブジェクトを生成する
        function createLathe(x,y,z) {
            var points = [];
            points[0] = new THREE.Vector2(0,0);
            points[1] = new THREE.Vector2(2,4);
            points[2] = new THREE.Vector2(3,9);
            points[3] = new THREE.Vector2(1,11);
            points[4] = new THREE.Vector2(0,11);

            var geometry = new THREE.LatheGeometry(points, 50);
            geometry.computeVertexNormals();
            var material = new THREE.MeshNormalMaterial();
            // 回転体オブジェクトの生成
            var lathe = new THREE.Mesh(geometry, material);
            lathe.rotation.set(Math.PI/2,0,0);
            lathe.position.set(x,y,z);
            lathes.push(lathe);
            return lathe;
        }

        function draw() {
            trackball.update();
            renderer.render(scene, camera);
            requestAnimationFrame(draw);
        }

    </script>
</head>
<body>
    <div id="canvas-frame"></div>
</body>
</html>