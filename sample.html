<!DOCTYPE html>
<html>
<head lang="en">
    <meta charset="UTF-8">
    <title>three.jsサンプル</title>
    <script src="./lib/three.min.js"></script>
    <script src="./lib/TrackballControls.js"></script>
    <script src="./lib/DragControls.js"></script>
    <script src="./lib/Projector.js"></script>
    <style>
        *{padding:0px; margin:0px}
        div#canvas-frame{
            width: 500px;
            height: 500px;
        }
    </style>
    <script>
        window.addEventListener("load", function() {
           threeStart();
        });
        function threeStart() {
            initThree();
            initTooltip();
            initCamera();
            initLight();
            initObject();
            draw();
        }

        var renderer,scene,canvasFrame;

        function initThree() {
            canvasFrame = document.getElementById('canvas-frame');
            renderer = new  THREE.WebGLRenderer();
            if (!renderer) alert("three.jsの初期化に失敗しました。");
            // レンダラーオブジェクトのサイズ指定
            renderer.setSize(canvasFrame.clientWidth, canvasFrame.clientHeight);

            canvasFrame.appendChild(renderer.domElement);
            // レンダラーオブジェクトのクリアーカラー設定
            renderer.setClearColor(0x87CEEB, 1.0);
            // 影を生成する
            renderer.shadowMap.enabled = true;
            // シーンオブジェクトの生成
            scene = new THREE.Scene();
        }

        var tooltipSprite;
        var tooltipContext;
        var tooltipTexture;
        function initTooltip() {
            renderer.getContext()
            var tooltipCanvas = document.createElement('canvas');
            tooltipContext = tooltipCanvas.getContext('2d');
            tooltipContext.font = "Bold 20px Arial";
            tooltipContext.fillStyle = "rgba(0,0,0,0.95)";
            tooltipTexture =  new THREE.Texture(tooltipCanvas);
            tooltipTexture.needsUpdate = true;
            var spriteMaterial = new THREE.SpriteMaterial( { map: tooltipTexture} );
            tooltipSprite = new THREE.Sprite( spriteMaterial );
            tooltipSprite.scale.set(200,100,1.0);
            tooltipSprite.position.set( 50, 50, 200 );
            scene.add(tooltipSprite);
        }

        var camera;
        var trackball;
        var dragcontrols;
        var floor = 1;
        function initCamera() {
            camera = new THREE.PerspectiveCamera(45, canvasFrame.clientWidth / canvasFrame.clientHeight, 1, 10000);

            // カメラ位置設定
            camera.position.set(300,300,180);
            // カメラの上ベクトルの設定
            camera.up.set(0,0,1);
            // カメラの中心位置ベクトルの設定
            camera.lookAt({x: 0, y: 0, z: 0});

            // トラックボールオブジェクト生成
            trackball = new THREE.TrackballControls(camera, canvasFrame);
            // トラックボールによる回転を有効にする。
            trackball.noRotate = false;
            // 回転速度の設定
            trackball.rotateSpeed = 2.0;
            // トラックボールによるズームの有効化
            trackball.noZoom = false;
            // ズーム速度の設定
            trackball.zoomSpeed = 1.0;
            // トラックボールによるカメラ視野中心座標移動の有効化
            trackball.noPan = false;
            trackball.panSpeed = 1.0;
            trackball.target = new THREE.Vector3(0,0,10);
            // マウス左ボタンドラッグ終了で回転をストップさせる。
            trackball.staticMoving = true;
            // マウス左ボタンドラッグ終了後の回転の減衰定数設定
            trackball.dynamicDampingFactor = 0.3;
            var dragObject = null; // ドラッグ対象オブジェクト
            // ドラッグコントロールオブジェクトの生成
            dragcontrols = new THREE.DragControls(camera, null, renderer.domElement);
            // ドラッグコントロールを有効化
            dragcontrols.enabled = true;

            // マウスオーバーイベントの登録
            dragcontrols.on('hoveron', function(e){
                cube2.material.visible = false; // 現在の階より上を非表示にする。
                // トラックボールオブジェクトを無効化
                trackball.enabled = false;
                // マウスドラッグ対象オブジェクトを更新
                dragObject = e.object;
                // tooltipを表示する。
                if(dragObject.tooltipValue) {
                    tooltipContext.clearRect(0,0,640,480);
                    var metrics = tooltipContext.measureText(dragObject.tooltipValue);
                    var width = metrics.width;
                    tooltipContext.fillStyle = "rgba(0,0,0,1)"; // black border
                    tooltipContext.fillRect( 0,0, width+8,20+8);
                    tooltipContext.fillStyle = "rgba(255,255,255,1)"; // white filler
                    tooltipContext.fillRect( 2,2, width+4,20+4 );
                    tooltipContext.fillStyle = "rgba(0,0,0,1)"; // text color
                    tooltipContext.fillText( dragObject.tooltipValue, 4,20 );
                    tooltipSprite.position.set( dragObject.position.x-50, dragObject.position.y+100, floor*10+10 );
                    tooltipTexture.needsUpdate = true;
                }
            });

            // マウスアウトイベントの登録
            dragcontrols.on('hoveroff', function(e){
                cube2.material.visible = true; // 現在の階より上を表示する。
                // トラックボールオブジェクトを有効化
                trackball.enabled = true;
//                // マウスオーバーしたオブジェクトが平面にない場合、位置を調整する。
                if(e) {
                    e.object.position.setZ(floor*5);
                    if(e.object.position.x > cubeX/2) {
                        e.object.position.setX(cubeX/2);
                    } else if(e.object.position.x < -1*cubeX/2) {
                        e.object.position.setX(-1*cubeX/2);
                    }

                    if(e.object.position.y > cubeY/2) {
                        e.object.position.setY(cubeY/2);
                    } else if(e.object.position.y < -1*cubeY/2) {
                        e.object.position.setY(-1*cubeY/2);
                    }
                    // tooltipを非表示にする。
                    if(e.object.tooltipValue){
                        tooltipContext.clearRect(0,0,300,300);
                        tooltipTexture.needsUpdate = true;
                    }

                }
                // ドラッグ対象オブジェクトを無しとする。
                dragObject = null;
            });
        }


        // 光源の初期化
        var directionalLight; // 平行光源オブジェクト
        function initLight() {
            directionalLight = new THREE.DirectionalLight(0xFFFFFF, 1.0);
            // 光源位置の設定
            directionalLight.position.set(50,30,100);
            directionalLight.castShadow = true;
            // シャドーカメラのサイズ指定
            directionalLight.shadow.camera.left = -100; // 左
            directionalLight.shadow.camera.right = 100; // 右
            directionalLight.shadow.camera.top = 100; // 上
            directionalLight.shadow.camera.bottom = -100; // 下
            directionalLight.shadow.camera.near = 0; // 手前
            directionalLight.shadow.camera.far = 300; // 奥

            // シーンへ光源を追加
            scene.add(directionalLight);
        }

        var axis; // 軸オブジェクト
        var cubeX = 100;
        var cubeY = 100;
        var cubeZ = 200;
        var cube2;
        function initObject() {
            // グループを生成
            var objectGroup = new THREE.Group();

            // グリッドオブジェクトの生成
            var grid = new THREE.GridHelper(cubeX/2, 10);
            grid.rotation.set(Math.PI/2, 0, 0);
            grid.position.set(0,0,floor*10)
            objectGroup.add(grid);

            // 平面オブジェクトの生成
            var planeGeometry = new THREE.PlaneGeometry(400,400);
            var planeMaterial = new THREE.MeshLambertMaterial({color: 0xDCDCDC});
            var plane = new THREE.Mesh(planeGeometry, planeMaterial);
            plane.receiveShadow = true;
            plane.position.set(0,0,0);
            objectGroup.add(plane);


            // 直方体を生成
            var height = 10;
            var cube1 =  createCube(cubeX, cubeY, height, false);
            // 影を描画オブジェクトにする。
            cube1.receiveShadow = true;
            // 影の発生元にもなる。
            cube1.castShadow = true;
            cube2 = createCube(cubeX, cubeY, cubeZ - height, true);
            cube2.position.setZ(cubeZ/2);
            // 直方体をグループに追加
            objectGroup.add(cube1);
            objectGroup.add(cube2);

            // 回転体を追加
            var lathe = createLathe(0,0,floor*5);
            lathe.tooltipValue = '機材1';
            objectGroup.add(lathe);
            lathe = createLathe(20,0,floor*5);
            lathe.tooltipValue = '機材2';
            objectGroup.add(lathe);


            // 回転体オブジェクトの配列をドラッグコントロール対象に追加
            dragcontrols.setObjects(lathes);

            // オブジェクトグループをシーンに追加
            scene.add(objectGroup);
        }

        function createCube(x, y, z, transparent) {
            // 形状オブジェクトを生成
            var geometry = new THREE.BoxGeometry(x, y, z);
            // 材質オブジェクトを生成
            var material = new THREE.MeshPhongMaterial({color: 0x008B8B, specular: 0x5F9EA0, shininess: 30, opacity: 0.2, transparent:transparent});
            // 直方体を生成
            return new THREE.Mesh(geometry, material);
        }

        var lathes=[]; // 回転体オブジェクトの配列
        // 回転体オブジェクトを生成する
        function createLathe(x,y,z) {
            var points = [];
            points[0] = new THREE.Vector2(0,0);
            points[1] = new THREE.Vector2(2,4);
            points[2] = new THREE.Vector2(3,9);
            points[3] = new THREE.Vector2(1,11);
            points[4] = new THREE.Vector2(0,11);

            var geometry = new THREE.LatheGeometry(points, 50);
            geometry.computeVertexNormals();
            var material = new THREE.MeshNormalMaterial();
            // 回転体オブジェクトの生成
            var lathe = new THREE.Mesh(geometry, material);
            lathe.rotation.set(Math.PI/2,0,0);
            lathe.position.set(x,y,z);
            // 影の生成元として指定
            lathe.castShadow = true;
            lathes.push(lathe);
            return lathe;
        }

        function draw() {
            trackball.update();
            renderer.render(scene, camera);
            requestAnimationFrame(draw);
        }

    </script>
</head>
<body>
    <div id="canvas-frame"></div>
</body>
</html>